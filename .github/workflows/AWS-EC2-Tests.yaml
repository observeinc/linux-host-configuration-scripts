run-name: AWS EC2 - ${{ github.event_name }} by @${{ github.actor }}
name: PR Tests V2
concurrency: aws-workflow
on: 
  workflow_dispatch:
  # pull_request:

  schedule:
    # only runs on default branch
    # * is a special character in YAML so you have to quote this string
    - cron:  '15 */12 * * *'

jobs:
  
  Run-Test-Build:
    strategy:
      max-parallel: 30
      fail-fast: false
      matrix:
        test_groups: ['base_defaults']
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: write
      pull-requests: write
      issues: read
      checks: write
    env:
      TF_VAR_REGION: "us-west-2"
      WORK_DIR: test_code_v2
      # TF_LOG: DEBUG

    steps:
      # AWS Login - orig role - has to occur before checkout
      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v1
        with:
          role-to-assume: ${{ secrets.THUNDERDOME_AWS_ROLE }}
          aws-region: ${{ env.TF_VAR_REGION }}


      - name: Check out repository code
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10' 

      - name: Run Tests
        run: |
          pip install -r requirements.txt
          python main.py
        working-directory: "${{ env.WORK_DIR }}/python"
        env:
          OBSERVE_CUSTOMER: ${{ secrets.TERRAFORM_MODULES_TEST_OBSERVE_CUSTOMER }}
          OBSERVE_DOMAIN: ${{ secrets.TERRAFORM_MODULES_TEST_OBSERVE_DOMAIN }}
          OBSERVE_USER_EMAIL: ${{ secrets.TERRAFORM_MODULES_TEST_OBSERVE_USER_EMAIL }}
          OBSERVE_USER_PASSWORD: ${{ secrets.TERRAFORM_MODULES_TEST_OBSERVE_USER_PASSWORD }}
          O2_OBSERVE_TOKEN: ${{ secrets.O2_OBSERVE_TOKEN }}

      - name: Print Environment Variables - troubleshooting
        run: |
          env | sort -f

      - name: Fail Check
        if: ${{ env.TEST_RESULT == 'FAIL' }} 
        uses: actions/github-script@v3
        with:
          script: |
              core.setFailed('Integration tests failed')
